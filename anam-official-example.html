<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anam Official Example</title>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            background: #000; 
            color: white;
            font-family: Arial, sans-serif;
        }
        #anamVideo { 
            width: 400px; 
            height: 300px; 
            border: 1px solid white;
            background: #333;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border-radius: 4px;
        }
        .error { background: #600; }
        .success { background: #060; }
    </style>
</head>
<body>
    <h1>Anam Official Example Test</h1>
    <div id="status" class="status">Initializing...</div>
    <video id="anamVideo" autoplay muted playsinline></video>
    
    <script>
        const statusDiv = document.getElementById('status');
        
        function updateStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            console.log(message);
        }
        
        // Use the exact format from Anam's official documentation
        async function initializeAnam() {
            try {
                updateStatus('Loading Anam SDK...');
                
                // Load the SDK dynamically to ensure it's available
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/@anam-ai/js-sdk@latest/dist/umd/anam.js';
                script.onload = async () => {
                    try {
                        updateStatus('SDK loaded, checking methods...');
                        
                        if (!window.anam) {
                            throw new Error('Anam SDK not loaded');
                        }
                        
                        console.log('Available Anam methods:', Object.keys(window.anam));
                        
                        // Try the session token approach first (server-side API key)
                        updateStatus('Attempting session token generation...');
                        
                        const response = await fetch('https://iegsoumvmhvvhmdyxhxs.supabase.co/functions/v1/generate-anam-token', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                // Note: This would normally require authentication
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.sessionToken) {
                                updateStatus('Session token received, creating client...', 'success');
                                
                                const { createClientWithSessionToken } = window.anam;
                                const anamClient = createClientWithSessionToken(data.sessionToken);
                                
                                anamClient.addListener('VIDEO_PLAY_STARTED', () => {
                                    updateStatus('Video started successfully!', 'success');
                                    setTimeout(() => {
                                        anamClient.talk('Hello! I am Alan from Savannah Tesla.');
                                    }, 1000);
                                });
                                
                                anamClient.addListener('ERROR', (error) => {
                                    updateStatus('Client error: ' + JSON.stringify(error), 'error');
                                });
                                
                                anamClient.streamToVideoElement('anamVideo');
                                return;
                            }
                        }
                        
                        throw new Error('Session token generation failed');
                        
                    } catch (error) {
                        updateStatus('Initialization failed: ' + error.message, 'error');
                        console.error('Full error:', error);
                    }
                };
                script.onerror = () => {
                    updateStatus('Failed to load Anam SDK', 'error');
                };
                document.head.appendChild(script);
                
            } catch (error) {
                updateStatus('Setup error: ' + error.message, 'error');
            }
        }
        
        // Start initialization
        initializeAnam();
    </script>
</body>
</html>
