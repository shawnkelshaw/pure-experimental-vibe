<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Passport - Anam Integration</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #000; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        #persona-video { 
            width: 100vw; 
            height: 100vh; 
            object-fit: cover; 
        }
        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 10;
        }
        #start-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            font-size: 18px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: none;
            z-index: 10;
        }
    </style>
</head>
<body>
    <video id="persona-video" autoplay playsinline muted></video>
    <div id="status">Loading...</div>
    <button id="start-button">Click to Start Conversation</button>

    <!-- Use UMD version for better Safari compatibility -->
    <script src="https://unpkg.com/@anam-ai/js-sdk@latest/dist/umd/anam.js"></script>
    <script>
        // Safari-compatible version using UMD
        const API_KEY = "YTJkMGM0NjUtN2YyOS00YmNlLWJmYjUtZmY4ZmM2ZDBlN2Y2OkdtRlB4TEkwWklndVNvRDhxK1pHaVhNUmk2ZG9GdHpLZjhUTCtSbERqSDA9";
        
        const videoElement = document.getElementById("persona-video");
        const statusElement = document.getElementById("status");
        const startButton = document.getElementById("start-button");
        let anamClient = null;

        function updateStatus(message, type = 'info') {
            statusElement.textContent = message;
            if (type === 'error') {
                statusElement.style.background = "rgba(255,0,0,0.8)";
            } else if (type === 'success') {
                statusElement.style.background = "rgba(0,255,0,0.8)";
            } else {
                statusElement.style.background = "rgba(0,0,0,0.8)";
            }
            console.log(message);
        }

        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                console.error("Microphone permission denied:", error);
                updateStatus("Microphone access required for conversation", 'error');
                return false;
            }
        }

        async function createSessionToken() {
            const response = await fetch("https://api.anam.ai/v1/auth/session-token", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${API_KEY}`,
                },
                body: JSON.stringify({
                    personaConfig: {
                        name: "Sarah Mitchell",
                        avatarId: "bdaaedfa-00f2-417a-8239-8bb89adec682",
                        voiceId: "b7bf471f-5435-49f8-a979-4483e4ccc10f", 
                        llmId: "ANAM_GPT_4O_MINI_V1",
                        systemPrompt: `You are Alan Subran's digital assistant, Sarah. You assist Alan by setting appointments on Alan's calendar and collecting vehicle passports from people like Shawn that want to begin the trade-in process. You already know the user's name is Shawn and that Shawn drives a 2023 Tesla. Keep responses conversational and concise. When Shawn confirms an appointment, mention that his Tesla's vehicle passport information will be automatically collected and downloaded in order to calculate an accurrate trade-in valuation. The results of the calculated valuation will be emailed to Shawn and Alan along with the appointment's location, date and time. Shawn does not need to take any action at this time.`,
                    },
                }),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            return data.sessionToken;
        }

        async function startChat() {
            try {
                updateStatus("Creating session...");
                
                // Check if Anam SDK loaded
                if (!window.anam || !window.anam.createClient) {
                    throw new Error("Anam SDK not loaded properly");
                }
                
                const sessionToken = await createSessionToken();
                
                updateStatus("Connecting...");
                anamClient = window.anam.createClient(sessionToken);
                
                // Add event listeners
                anamClient.addListener('CONNECTION_ESTABLISHED', () => {
                    console.log('Connection established');
                    updateStatus("Connected! Setting up audio...");
                });
                
                anamClient.addListener('STREAM_STARTED', () => {
                    console.log('Stream started');
                    updateStatus("Video stream active");
                });
                
                anamClient.addListener('ERROR', (error) => {
                    console.error('Anam client error:', error);
                    updateStatus(`Error: ${error.message || 'Unknown error'}`, 'error');
                });
                
                await anamClient.streamToVideoElement("persona-video");
                
                updateStatus("Ready! Click to start conversation", 'success');
                startButton.style.display = 'block';
                
            } catch (error) {
                console.error("Failed to start chat:", error);
                updateStatus(`Failed to connect: ${error.message}`, 'error');
            }
        }

        async function startConversation() {
            try {
                const hasPermission = await requestMicrophonePermission();
                if (!hasPermission) return;
                
                startButton.style.display = 'none';
                updateStatus("Starting conversation...");
                
                // Unmute video for audio output
                videoElement.muted = false;
                
                // Enable audio context (required for iOS Safari)
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    if (audioContext.state === 'suspended') {
                        await audioContext.resume();
                    }
                } catch (audioError) {
                    console.warn("Audio context setup failed:", audioError);
                }
                
                // Start conversation
                setTimeout(() => {
                    anamClient.talk("Hello Shawn! I'm Sarah, Alan's digital assistant. I understand you're interested in a Tesla trade-in. I can help schedule an appointment with Alan and collect your vehicle passport information. How can I assist you today?");
                }, 1000);
                
                // Hide status after greeting
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 4000);
                
            } catch (error) {
                console.error("Failed to start conversation:", error);
                updateStatus(`Conversation error: ${error.message}`, 'error');
            }
        }

        // Event listeners
        startButton.addEventListener('click', startConversation);

        // Wait for SDK to load, then start
        window.addEventListener('load', () => {
            setTimeout(startChat, 500); // Small delay to ensure SDK is ready
        });
    </script>
</body>
</html>
