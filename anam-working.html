<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alan - Tesla Trade In</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #000; 
            color: white;
            font-family: Arial, sans-serif;
        }
        #persona-video { 
            width: 100vw; 
            height: 100vh; 
            object-fit: cover; 
        }
        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <video id="persona-video" autoplay playsinline></video>
    <div id="status">Loading...</div>
    <button id="start-button" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 15px 30px; font-size: 18px; background: #007AFF; color: white; border: none; border-radius: 8px; cursor: pointer; display: none;">
        Click to Start Conversation
    </button>

    <script type="module">
        import { createClient } from "https://esm.sh/@anam-ai/js-sdk@latest";

        // Replace with your actual API key
        const API_KEY = "YTJkMGM0NjUtN2YyOS00YmNlLWJmYjUtZmY4ZmM2ZDBlN2Y2OkdtRlB4TEkwWklndVNvRDhxK1pHaVhNUmk2ZG9GdHpLZjhUTCtSbERqSDA9";
        
        const videoElement = document.getElementById("persona-video");
        const statusElement = document.getElementById("status");
        const startButton = document.getElementById("start-button");
        let anamClient = null;

        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // Stop the stream immediately - we just needed permission
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                console.error("Microphone permission denied:", error);
                statusElement.textContent = "Microphone access required for conversation";
                statusElement.style.background = "rgba(255,165,0,0.8)";
                return false;
            }
        }

        async function createSessionToken() {
            const response = await fetch("https://api.anam.ai/v1/auth/session-token", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${API_KEY}`,
                },
                body: JSON.stringify({
                    personaConfig: {
                        name: "Sarah Mitchell",
                        avatarId: "bdaaedfa-00f2-417a-8239-8bb89adec682",
                        voiceId: "b7bf471f-5435-49f8-a979-4483e4ccc10f", 
                        llmId: "ANAM_GPT_4O_MINI_V1",
                        systemPrompt: `You are Alan Subran's digital assistant, Sarah. You assist Alan by setting appointments on Alan's calendar and collecting vehicle passports from people like Shawn that want to begin the trade-in process. You already know the user's name is Shawn and that Shawn drives a 2023 Tesla. Keep responses conversational and concise. When Shawn confirms an appointment, mention that his Tesla's vehicle passport information will be automatically collected and downloaded in order to calculate an accurrate trade-in valuation. The results of the calculated valuation will be emailed to Shawn and Alan along with the appointment's location, date and time. Shawn does not need to take any action at this time.`,
                    },
                }),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            return data.sessionToken;
        }

        async function startChat() {
            try {
                statusElement.textContent = "Creating session...";
                const sessionToken = await createSessionToken();
                
                statusElement.textContent = "Connecting...";
                anamClient = createClient(sessionToken);
                
                // Add event listeners for debugging
                anamClient.addListener('CONNECTION_ESTABLISHED', () => {
                    console.log('Connection established');
                    statusElement.textContent = "Connected! Setting up audio...";
                });
                
                anamClient.addListener('STREAM_STARTED', () => {
                    console.log('Stream started');
                    statusElement.textContent = "Video stream active";
                });
                
                anamClient.addListener('AUDIO_PLAY_STARTED', () => {
                    console.log('Audio playback started');
                    statusElement.textContent = "Audio enabled - Alan can speak";
                });
                
                anamClient.addListener('LISTENING_STARTED', () => {
                    console.log('Listening started');
                    statusElement.textContent = "Listening for your voice...";
                });
                
                anamClient.addListener('LISTENING_STOPPED', () => {
                    console.log('Listening stopped');
                });
                
                anamClient.addListener('ERROR', (error) => {
                    console.error('Anam client error:', error);
                    statusElement.textContent = `Error: ${error.message || 'Unknown error'}`;
                    statusElement.style.background = "rgba(255,0,0,0.8)";
                });
                
                await anamClient.streamToVideoElement("persona-video");
                
                statusElement.textContent = "Ready! Click to start conversation";
                startButton.style.display = 'block';
                
            } catch (error) {
                console.error("Failed to start chat:", error);
                statusElement.textContent = `Failed to connect: ${error.message}`;
                statusElement.style.background = "rgba(255,0,0,0.8)";
            }
        }

        async function startConversation() {
            try {
                // Request microphone permission first
                const hasPermission = await requestMicrophonePermission();
                if (!hasPermission) return;
                
                startButton.style.display = 'none';
                statusElement.textContent = "Starting conversation...";
                
                // Audio is already enabled when the client connects
                // No need to call enableAudio() - it's handled automatically
                
                // Start conversation
                setTimeout(() => {
                    anamClient.talk("Hello Shawn! I'm Alan from Savannah Tesla. I understand you're interested in a trade-in for your 2023 Tesla. How can I help you today?");
                }, 1000);
                
                // Hide status after greeting
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 4000);
                
            } catch (error) {
                console.error("Failed to start conversation:", error);
                statusElement.textContent = `Conversation error: ${error.message}`;
                statusElement.style.background = "rgba(255,0,0,0.8)";
            }
        }

        // Event listeners
        startButton.addEventListener('click', startConversation);

        // Auto-start session creation when page loads
        startChat();
    </script>
</body>
</html>
